import React, { useState, useMemo, useEffect, useRef } from 'react';
import { HashRouter, Routes, Route, Link, NavLink, useNavigate, Navigate, useLocation, useParams } from 'react-router-dom';
import { ToastContainer, toast, TypeOptions } from 'react-toastify';
import { User, UserRole, Produce, Contract, ContractStatus, Transaction, TransactionType, Message } from './types';
import { useAuth } from './contexts/AuthContext';
import { useData } from './contexts/DataContext';
import VerifyOtpScreen from './components/VerifyOtpScreen';

// --- ICONS --- //
const HomeIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
const LeafIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 20A7 7 0 0 1 4 13V8a5 5 0 0 1 10 0v5a7 7 0 0 1-7 7m0 0c-3.33 0-5.46-2.01-6-5h12c-.54 2.99-2.67 5-6 5"></path><path d="M12 13V3"></path></svg>;
const FileTextIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>;
const UserIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
const UsersIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const LogOutIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
const StarIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
const ChevronLeftIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>;
const CheckCircleIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>;
const MapPinIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
const TruckIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 17h4V5H2v12h3"/><path d="M22 17h-2.42a1 1 0 0 0-.9-.58h-1.36a1 1 0 0 0-.9.58H14V5h8v12Z"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>;
const ShieldAlertIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>;
const SearchIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>;
const Trash2Icon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>;
const PlusIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
const XIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
const EditIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
const WalletIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><path d="M20 12V8H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg>;
const MinusIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
const BarChartIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></svg>;
const MessageSquareIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
const QrCodeIcon = ({ className }: { className?: string }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" className={className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><line x1="14" x2="14.01" y1="14" y2="14"></line><line x1="17" x2="21" y1="14" y2="14"></line><line x1="14" x2="14" y1="17" y2="21"></line><line x1="17" x2="17" y1="17" y2="17.01"></line><line x1="21" x2="21" y1="17" y2="17.01"></line><line x1="21" x2="21" y1="21" y2="21.01"></line></svg>;

// --- NOTIFICATION CONTEXT (local only) --- //
interface NotificationContextType { notify: (message: string, type?: TypeOptions) => void; }
const NotificationContext = React.createContext<NotificationContextType | null>(null);
const NotificationProvider = ({ children }: { children: React.ReactNode }) => {
  const notify = (message: string, type: TypeOptions = 'info') => { toast(message, { type, position: 'top-center' }); };
  const value = useMemo(() => ({ notify }), []);
  return <NotificationContext.Provider value={value}>{children}</NotificationContext.Provider>;
};
const useNotifier = () => { const ctx = React.useContext(NotificationContext); if (!ctx) throw new Error('useNotifier must be used within NotificationProvider'); return ctx; };

// --- ROUTING --- //
const ProtectedRoute = ({ children }: { children?: React.ReactNode }) => { const { user, loadingAuth } = useAuth(); const location = useLocation(); if (loadingAuth) return <div className="p-8 text-center">Loading...</div>; if (!user) return <Navigate to="/login" state={{ from: location }} replace />; return <>{children}</>; };

// --- UI HELPERS --- //

const getStatusColor = (status: ContractStatus) => {
  switch (status) {
    case ContractStatus.ACTIVE: return 'text-blue-600 bg-blue-100';
    case ContractStatus.COMPLETED: return 'text-green-600 bg-green-100';
    case ContractStatus.DELIVERY_CONFIRMED: return 'text-yellow-600 bg-yellow-100';
    case ContractStatus.PAYMENT_RELEASED: return 'text-purple-600 bg-purple-100';
    case ContractStatus.PENDING: return 'text-gray-600 bg-gray-100';
    case ContractStatus.DISPUTED: return 'text-orange-600 bg-orange-100';
    default: return 'text-red-600 bg-red-100';
  }
};

const ProduceCard: React.FC<{ produce: Produce }> = ({ produce }) => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const { notify } = useNotifier();

  const handleMakeOffer = () => {
    if (user?.role === UserRole.VENDOR) {
      navigate(`/produce/${produce.id}/new-contract`);
    } else {
      notify("Only vendors can make offers.", "info");
    }
  };
  
  const handleCreateContract = () => {
    navigate(`/my-produce/${produce.id}/new-contract`);
  };

  return (
    <div className="bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300">
      <img src={produce.imageUrl} alt={produce.name} className="w-full h-48 object-cover" />
      <div className="p-4">
        <h3 className="text-lg font-bold text-gray-800">{produce.name}</h3>
        <p className="text-sm text-gray-500">{produce.type}</p>
        <div className="mt-2 text-sm text-gray-700">
          <p>By: <span className="font-semibold">{produce.farmerName}</span></p>
          <p>Location: <span className="font-semibold">{produce.location}</span></p>
          <p>Quantity: <span className="font-semibold">{produce.quantity} kg</span></p>
        </div>
        <div className="mt-4 flex justify-between items-center">
          <p className="text-lg font-bold text-green-600">KES {produce.pricePerKg}<span className="text-sm font-normal text-gray-500">/kg</span></p>
          {user?.role === UserRole.VENDOR && (
            <button 
              onClick={handleMakeOffer}
              className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors"
            >
              Make Offer
            </button>
          )}
           {user?.role === UserRole.FARMER && (
            <button 
              onClick={handleCreateContract}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
            >
              Create Contract
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

const ContractCard: React.FC<{ contract: Contract }> = ({ contract }) => {
  const navigate = useNavigate();
  return (
    <div 
      className="bg-white p-4 rounded-lg shadow-md mb-4 cursor-pointer hover:shadow-lg transition-shadow"
      onClick={() => navigate(`/contracts/${contract.id}`)}
    >
      <div className="flex justify-between items-start">
        <div>
          <h3 className="font-bold text-gray-800">{contract.produceName}</h3>
          <p className="text-sm text-gray-500">
            {contract.farmerName} to {contract.vendorName}
          </p>
        </div>
        <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(contract.status)}`}>
          {contract.status}
        </span>
      </div>
      <div className="mt-4 border-t pt-4 text-sm grid grid-cols-2 gap-2 text-gray-700">
        <div>
          <p className="text-gray-500">Quantity</p>
          <p className="font-semibold">{contract.quantity} kg</p>
        </div>
        <div>
          <p className="text-gray-500">Total Price</p>
          <p className="font-semibold">KES {contract.totalPrice.toLocaleString()}</p>
        </div>
        <div>
          <p className="text-gray-500">Deadline</p>
          <p className="font-semibold">{contract.deliveryDeadline}</p>
        </div>
        {contract.paymentDate && (
          <div>
            <p className="text-gray-500">Paid On</p>
            <p className="font-semibold">{contract.paymentDate}</p>
          </div>
        )}
      </div>
    </div>
  );
};

const MapView: React.FC<{ users: User[]; currentUserId?: string }> = ({ users, currentUserId }) => {
    // Define a bounding box for Kenya to normalize coordinates
    const bounds = {
        minLat: -5.0, maxLat: 5.0,
        minLng: 34.0, maxLng: 42.0,
    };

    const getPosition = (lat: number, lng: number) => {
        const x = ((lng - bounds.minLng) / (bounds.maxLng - bounds.minLng)) * 100;
        const y = ((bounds.maxLat - lat) / (bounds.maxLat - bounds.minLat)) * 100;
        return { x, y };
    };

    return (
        <div className="relative w-full h-64 bg-green-100 rounded-lg shadow-md overflow-hidden">
            <img src={`https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/38,0,3/400x300?access_token=pk.eyJ1IjoiZGFuaWVsc2hlYSIsImEiOiJjanl2Z285eWUwZm8wM25udWk0YWM1dHE5In0.kVoL_2Wnx32b3n_84yweJA`} alt="Map of Kenya" className="w-full h-full object-cover opacity-70" />
            {users.map(user => {
                if (!user.lat || !user.lng) return null;
                const { x, y } = getPosition(user.lat, user.lng);
                const isFarmer = user.role === UserRole.FARMER;
                const isCurrentUser = user.id === currentUserId;
                return (
                    <div
                        key={user.id}
                        className="absolute group"
                        style={{ left: `${x}%`, top: `${y}%`, transform: 'translate(-50%, -100%)' }}
                    >
                        <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                          {user.name} {isCurrentUser && '(You)'} <br/> ({user.location.split(',')[0]})
                        </div>
                        <MapPinIcon className={`w-8 h-8 ${isCurrentUser ? 'text-blue-500' : isFarmer ? 'text-green-600' : 'text-amber-500'} drop-shadow-lg`} />
                    </div>
                );
            })}
        </div>
    );
};


// --- LAYOUT --- //
const Layout = ({ children, showNav = true }: { children?: React.ReactNode, showNav?: boolean }) => {
  return (
    <div className="max-w-md mx-auto bg-gray-100 min-h-screen flex flex-col font-sans">
      <main className={`flex-grow ${showNav ? 'pb-20' : ''}`}>
        {children}
      </main>
      {showNav && <BottomNav />}
    </div>
  );
};

const BottomNav = () => {
  const { user } = useAuth();

  const navItems = [
    { path: '/dashboard', label: 'Dashboard', icon: HomeIcon },
    { path: '/produce', label: 'Produce', icon: LeafIcon },
    { path: '/contracts', label: 'Contracts', icon: FileTextIcon },
    { path: '/insights', label: 'Insights', icon: BarChartIcon },
  ];

  if (user?.role !== UserRole.ADMIN) {
      navItems.push({ path: '/wallet', label: 'Wallet', icon: WalletIcon });
  }
  
  navItems.push({ path: '/profile', label: 'Profile', icon: UserIcon });


  return (
    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 shadow-t-md">
      <div className="flex justify-around h-16">
        {navItems.map((item) => (
          <NavLink
            key={item.path}
            to={item.path}
            className={({ isActive }) => `flex flex-col items-center justify-center w-full text-sm font-medium transition-colors ${isActive ? 'text-green-600' : 'text-gray-500 hover:text-green-500'}`}
          >
            <item.icon className="w-6 h-6 mb-1" />
            <span>{item.label}</span>
          </NavLink>
        ))}
      </div>
    </nav>
  );
};

const Header = ({ title, showBack = false }: { title: string, showBack?: boolean }) => {
    const navigate = useNavigate();
    return (
        <header className="sticky top-0 bg-white shadow-sm z-10 p-4 flex items-center">
            {showBack && (
                <button onClick={() => navigate(-1)} className="absolute left-4">
                    <ChevronLeftIcon className="w-6 h-6 text-gray-600" />
                </button>
            )}
            <h1 className="text-xl font-bold text-center text-gray-800 flex-grow">{title}</h1>
        </header>
    );
};


// --- SCREENS --- //

const LoginModal = ({ 
    onClose, 
    onLoginSuccess 
}: { 
    onClose: () => void; 
    onLoginSuccess: () => void;
}) => {
    const [step, setStep] = useState<'role' | 'form'>('role');
    const [selectedRole, setSelectedRole] = useState<UserRole.FARMER | UserRole.VENDOR | null>(null);
    const { login } = useAuth();
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const roleConfig = {
        [UserRole.FARMER]: {
            demoUser: 'juma.mwangi@example.com',
        },
        [UserRole.VENDOR]: {
            demoUser: 'aisha.omar@example.com',
        },
    };

    const handleRoleSelect = (role: UserRole.FARMER | UserRole.VENDOR) => {
        setSelectedRole(role);
        setEmail(roleConfig[role].demoUser);
        setStep('form');
        setError('');
    };

    const handleLogin = (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        if (!email || !password) {
            setError('Please fill in both fields.');
            return;
        }
        const success = login(email, password);
        if (success) {
            onLoginSuccess();
        } else {
            setError('Invalid email or password.');
        }
    };

    return (
        <div 
            className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
            onClick={onClose}
            role="dialog"
            aria-modal="true"
        >
            <div 
                className="bg-white rounded-2xl shadow-xl w-full max-w-sm transition-all duration-300 relative"
                onClick={e => e.stopPropagation()}
            >
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600" aria-label="Close">
                    <XIcon className="w-6 h-6" />
                </button>

                {step === 'role' && (
                    <div className="p-8">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Select Your Role</h2>
                        <div className="space-y-4">
                            <button
                                onClick={() => handleRoleSelect(UserRole.FARMER)}
                                className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105"
                            >
                                I'm a Farmer
                            </button>
                            <button
                                onClick={() => handleRoleSelect(UserRole.VENDOR)}
                                className="w-full bg-amber-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-amber-600 transition-all duration-300 transform hover:scale-105"
                            >
                                I'm a Vendor
                            </button>
                        </div>
                         <div className="mt-6 text-center">
                            <p className="text-sm text-gray-600">
                                Don't have an account?{' '}
                                <Link to="/onboarding" className="font-semibold text-green-600 hover:text-green-700">
                                    Sign Up
                                </Link>
                            </p>
                        </div>
                    </div>
                )}
                {step === 'form' && selectedRole && (
                     <div className="p-8">
                        <div className="flex items-center mb-6">
                            <button onClick={() => setStep('role')} className="text-gray-500 hover:text-gray-800">
                                <ChevronLeftIcon className="w-6 h-6" />
                            </button>
                            <h2 className="text-2xl font-bold text-center text-gray-800 flex-grow">
                                {selectedRole === UserRole.FARMER ? 'Farmer' : 'Vendor'} Login
                            </h2>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <InputField
                                label="Email Address"
                                name="email"
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="you@example.com"
                            />
                            <div>
                                <InputField
                                    label="Password"
                                    name="password"
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="••••••••"
                                />
                                 <div className="text-right mt-1">
                                    <Link 
                                      to="/forgot-password" 
                                      onClick={onClose} 
                                      className="text-sm font-medium text-green-600 hover:text-green-700"
                                    >
                                        Forgot Password?
                                    </Link>
                                </div>
                            </div>
                            {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                            <button
                                type="submit"
                                className={`w-full text-white py-3 rounded-lg font-semibold text-lg transition-all duration-300 transform hover:scale-105 ${
                                    selectedRole === UserRole.FARMER 
                                    ? 'bg-green-600 hover:bg-green-700' 
                                    : 'bg-amber-500 hover:bg-amber-600'
                                }`}
                            >
                                Login
                            </button>
                        </form>
                         <div className="mt-6 border-t pt-4 text-sm text-gray-500 text-center">
                            <p><span className="font-medium">Demo Email:</span> {roleConfig[selectedRole].demoUser}</p>
                            <p className="mt-1 italic">(Any password will work)</p>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

const LoginScreen = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, login } = useAuth();
  const [email, setEmail] = useState('');
  const [role, setRole] = useState<UserRole.FARMER | UserRole.VENDOR | null>(null);
  const [error, setError] = useState('');
  const [sending, setSending] = useState(false);

  useEffect(() => { if (user) { const from = location.state?.from?.pathname || '/dashboard'; navigate(from, { replace: true }); } }, [user, navigate, location]);

  const handleSendCode = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    if (!email) { setError('Email is required.'); return; }
    setSending(true);
    const success = await login(email);
    setSending(false);
    if (success) {
      navigate('/verify-otp', { state: { email } });
    } else {
      setError('Failed to send verification code');
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-green-50 p-4">
      <div className="text-center mb-10">
        <LeafIcon className="w-16 h-16 text-green-600 mx-auto" />
        <h1 className="text-4xl font-bold text-green-800 mt-4">Mkulima Express</h1>
        <p className="text-gray-600 mt-2">Connecting Farmers & Vendors with Trust</p>
      </div>
      <div className="w-full max-w-sm bg-white p-6 rounded-xl shadow-md">
        <h2 className="text-xl font-semibold text-center mb-4">Login / Sign Up</h2>
        <form onSubmit={handleSendCode} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Role (for new users)</label>
            <div className="grid grid-cols-2 gap-2 mt-1">
              <button type="button" onClick={() => setRole(UserRole.FARMER)} className={`py-2 rounded-lg text-sm font-semibold ${role===UserRole.FARMER? 'bg-green-600 text-white':'bg-gray-100 text-gray-700'}`}>Farmer</button>
              <button type="button" onClick={() => setRole(UserRole.VENDOR)} className={`py-2 rounded-lg text-sm font-semibold ${role===UserRole.VENDOR? 'bg-amber-500 text-white':'bg-gray-100 text-gray-700'}`}>Vendor</button>
            </div>
            <p className="text-xs text-gray-500 mt-1">If you already have an account just enter your email.</p>
          </div>
          <InputField label="Email" name="email" type="email" value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="you@example.com" />
          {error && <p className="text-sm text-red-600 text-center">{error}</p>}
          <button type="submit" disabled={sending || !email} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-300">
            {sending? 'Sending code...':'Send Verification Code'}
          </button>
        </form>
        <div className="mt-6 text-center">
          <p className="text-sm text-gray-600">Administrator? <Link to="/admin/login" className="font-semibold text-green-600">Login here</Link></p>
        </div>
      </div>
    </div>
  );
};

const AdminLoginScreen = () => {
    const navigate = useNavigate();
    const location = useLocation();
    const { user, login } = useAuth();
    const [email, setEmail] = useState('');
    const [error, setError] = useState('');
    const [sending, setSending] = useState(false);
    useEffect(()=>{ if(user) navigate('/dashboard',{replace:true}); },[user]);
    const handleSendCode = async (e:React.FormEvent)=>{ e.preventDefault(); setError(''); if(!email){setError('Email required');return;} setSending(true); const ok = await login(email); setSending(false); if(ok){ navigate('/verify-otp',{state:{email}}); } else setError('Failed to send code'); };
    return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-800 p-4">
            <div className="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
                <h2 className="text-2xl font-semibold text-center text-gray-700 mb-6">Admin Login</h2>
                <form onSubmit={handleSendCode} className="space-y-4">
                    <InputField label="Admin Email" name="email" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="admin@mkulima.express" />
                    {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                    <button type="submit" disabled={sending||!email} className="w-full bg-gray-700 text-white py-3 rounded-lg font-semibold hover:bg-gray-800 disabled:bg-gray-300">{sending?'Sending...':'Send Code'}</button>
                </form>
                <div className="mt-6 text-center"><Link to="/login" className="font-semibold text-sm text-green-600">&larr; Back</Link></div>
            </div>
        </div>
    );
};

const VerifyOtpScreen = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const { user, verifyOtp } = useAuth();
    const [otp, setOtp] = useState(['', '', '', '']);
    const [error, setError] = useState('');
    const [verifying, setVerifying] = useState(false);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>, index: number) => {
        const value = e.target.value.replace(/[^0-9]/g, ''); // Only digits
        setOtp(prev => {
            const newOtp = [...prev];
            newOtp[index] = value;
            return newOtp;
        });
        if (e.target.nextSibling && value) {
            e.target.nextSibling.focus();
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        const otpCode = otp.join('');
        if (otpCode.length !== 4) {
            setError('Please enter all 4 digits.');
            return;
        }
        setVerifying(true);
        try {
            const email = location.state?.email;
            if (typeof email !== 'string') throw new Error('Invalid email address.');
            const success = await verifyOtp(email, otpCode);
            if (success) {
                navigate('/dashboard', { replace: true });
            } else {
                setError('Invalid OTP. Please try again.');
            }
        } catch (err: any) {
            setError(err.message || 'Verification failed.');